<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluetooth Service Discover</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
        }

        button {
            font-size: 18px;
            padding: 15px;
        }

        pre {
            background-color: #eee;
            border: 1px solid #ccc;
            padding: 10px;
            height: 400px;
            overflow-y: scroll;
        }
    </style>
</head>

<body>
    <h1>Bluetooth Service Discover (v2)</h1>
    <p>This version now specifically requests permission for the standard "Serial Port Service" to get past the Android
        error.</p>
    <button id="connectButton">Connect & Discover Services</button>
    <pre id="log">Awaiting connection...</pre>

    <script>
        const connectButton = document.getElementById('connectButton');
        const logDiv = document.getElementById('log');

        // --- THIS IS THE FIX ---
        // We are now explicitly asking for the standard Serial Port Profile (SPP) UUID
        // to get past the "Origin is not allowed" error on Android.
        const SPP_SERVICE_UUID = '00001101-0000-1000-8000-00805f9b34fb';

        function log(message) {
            console.log(message);
            logDiv.textContent += message + '\n';
        }

        connectButton.addEventListener('click', async () => {
            log('Requesting Bluetooth device...');
            try {
                const device = await navigator.bluetooth.requestDevice({
                    // We can't use acceptAllDevices: true if we specify services.
                    // We will filter by the service we want.
                    filters: [{
                        services: [SPP_SERVICE_UUID]
                    }],
                    // And we also ask for it to be optional, to be safe.
                    optionalServices: [SPP_SERVICE_UUID]
                });

                log(`Connecting to GATT Server on ${device.name}...`);
                device.addEventListener('gattserverdisconnected', () => {
                    log('--- DEVICE DISCONNECTED ---');
                });
                const server = await device.gatt.connect();
                log('--- CONNECTED ---');
                log(`Device Name: ${device.name}`);
                log(`Device ID: ${device.id}`);

                log('\nDiscovering all services...');
                // Note: We're calling getPrimaryServices() *without* a UUID
                // to see if we can discover *all* services now that we have permission
                // for at least one.
                const services = await server.getPrimaryServices();

                if (services.length === 0) {
                    log('No services found. This could be a pairing issue or the wrong UUID.');
                    return;
                }

                log(`--- FOUND ${services.length} SERVICES ---`);

                for (const service of services) {
                    log(`\nFound Service: ${service.uuid}`);

                    try {
                        const characteristics = await service.getCharacteristics();
                        log(`  -> Found ${characteristics.length} Characteristics:`);

                        for (const char of characteristics) {
                            let properties = [];
                            if (char.properties.read) properties.push('read');
                            if (char.properties.write) properties.push('write');
                            if (char.properties.writeWithoutResponse) properties.push('writeWithoutResponse');
                            if (char.properties.notify) properties.push('notify');

                            log(`    -> Characteristic: ${char.uuid} (Supports: ${properties.join(', ')})`);
                        }
                    } catch (err) {
                        log(`    -> Error getting characteristics for this service: ${err.message}`);
                    }
                }
                log('\n--- DISCOVERY FINISHED ---');
                log('Please copy and paste this entire log back to me.');

            } catch (err) {
                log(`\n--- ERROR ---`);
                log(err.message);
            }
        });
    </script>
</body>

</html>